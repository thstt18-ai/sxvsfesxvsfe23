
#!/bin/bash

echo "๐ ะะฒัะพะผะฐัะธัะตัะบะฐั ะฝะฐัััะพะนะบะฐ ัะพัะณะพะฒะปะธ..."
echo ""

# 1. ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
echo "๐ฆ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน ะฒ contracts/..."
cd contracts

# ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั package.json
if [ ! -f "package.json" ]; then
    echo "โ ะัะธะฑะบะฐ: package.json ะฝะต ะฝะฐะนะดะตะฝ ะฒ contracts/"
    exit 1
fi

# ะฃััะฐะฝะพะฒะบะฐ ั legacy-peer-deps ะดะปั ัะพะฒะผะตััะธะผะพััะธ
npm install --legacy-peer-deps

if [ $? -ne 0 ]; then
    echo "โ ะัะธะฑะบะฐ ัััะฐะฝะพะฒะบะธ ะทะฐะฒะธัะธะผะพััะตะน"
    exit 1
fi

echo "โ ะะฐะฒะธัะธะผะพััะธ ัััะฐะฝะพะฒะปะตะฝั"

# 2. ะะพะผะฟะธะปััะธั ะบะพะฝััะฐะบัะพะฒ
echo ""
echo "๐จ ะะพะผะฟะธะปััะธั ะบะพะฝััะฐะบัะพะฒ..."
npx hardhat compile

if [ $? -ne 0 ]; then
    echo "โ ะัะธะฑะบะฐ ะบะพะผะฟะธะปััะธะธ ะบะพะฝััะฐะบัะพะฒ"
    exit 1
fi

echo "โ ะะพะฝััะฐะบัั ัะบะพะผะฟะธะปะธัะพะฒะฐะฝั"

# 3. ะะฐะทะฒะตัััะฒะฐะฝะธะต ะบะพะฝััะฐะบัะฐ
echo ""
echo "๐ง ะะฐะทะฒะตัััะฒะฐะฝะธะต ะบะพะฝััะฐะบัะฐ ะฝะฐ Amoy testnet..."
npm run deploy:amoy

# ะะพะปััะตะฝะธะต ะฐะดัะตัะฐ ะบะพะฝััะฐะบัะฐ
if [ -f ".env" ]; then
    CONTRACT_ADDRESS=$(grep "ARBITRAGE_EXECUTOR_ADDRESS" .env | cut -d '=' -f2)
fi

cd ..

if [ -z "$CONTRACT_ADDRESS" ]; then
    echo "โ๏ธ  ะะดัะตั ะบะพะฝััะฐะบัะฐ ะฝะต ะฝะฐะนะดะตะฝ ะฐะฒัะพะผะฐัะธัะตัะบะธ"
    echo "๐ ะัะพะฒะตัััะต ะฒัะฒะพะด ะบะพะผะฐะฝะดั ะฒััะต ะธ ัะบะพะฟะธััะนัะต ะฐะดัะตั ะฒัััะฝัั"
    exit 0
fi

echo "โ ะะพะฝััะฐะบั ัะฐะทะฒะตัะฝัั: $CONTRACT_ADDRESS"

# 4. ะะพะฟะธัะพะฒะฐะฝะธะต ะฐะดัะตัะฐ ะฒ ะบะพัะฝะตะฒะพะน .env
if grep -q "ARBITRAGE_CONTRACT=" .env 2>/dev/null; then
    sed -i "s/ARBITRAGE_CONTRACT=.*/ARBITRAGE_CONTRACT=$CONTRACT_ADDRESS/" .env
else
    echo "ARBITRAGE_CONTRACT=$CONTRACT_ADDRESS" >> .env
fi

echo "โ ะะดัะตั ะบะพะฝััะฐะบัะฐ ัะพััะฐะฝะตะฝ ะฒ .env"

echo ""
echo "โ ะะฐัััะพะนะบะฐ ะทะฐะฒะตััะตะฝะฐ!"
echo ""
echo "๐ ะะดัะตั ะบะพะฝััะฐะบัะฐ: $CONTRACT_ADDRESS"
echo "๐ ะัะบัะพะนัะต ะฟัะธะปะพะถะตะฝะธะต ะธ ะฟะตัะตะนะดะธัะต ะฒ Settings"
echo "๐ ะะดัะตั ะบะพะฝััะฐะบัะฐ ัะถะต ะฝะฐัััะพะตะฝ ะฐะฒัะพะผะฐัะธัะตัะบะธ"
echo ""
